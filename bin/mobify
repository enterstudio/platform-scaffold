#!/usr/bin/env bash

set -o errexit
set -o pipefail

_start() {
  if ! type docker >/dev/null 2>&1; then
    printf "Docker is required! Get Docker for Mac (https://docs.docker.com/docker-for-mac/) or Docker for Windows (https://docs.docker.com/docker-for-windows/).\n"
    exit 1
  fi

curl -X PUT http://start.mobify.com/progress/clone/enable

  printf '                        `:-.          \n'
  printf '                       -yyyyys+:`          \n'
  printf '                      /yyyyyyyyy`  +o+/:-.          \n'
  printf '                    `oyyyyyyyyy-  :hhhhhhhs          \n'
  printf '                   `syyyyyyyyy+   yhhhhhhhy          \n'
  printf '               `-/oyyyyyyyyyyo   :hhhhhhhhs          \n'
  printf '            -/oyyyyyyyyyyyyyo`   shhhhhhhhs          \n'
  printf '          +yyyyyyyyyyyyyyyy+    `hhhhhhhhho          \n'
  printf '          +yyyyyyyyyyyyyy+.     .hhhhhhhhho          \n'
  printf '          `yyyyyyyyys+/.         yhhhhhhhhhs`          \n'
  printf '           -yso+/-.`             .yhhhhhhhhhy.          \n'
  printf '                   ```.....`      `shhhhhhhhhy.          \n'
  printf '             -://++++++++++++/-`    /yhhhhhhhhy.          \n'
  printf '             /++++++++++++++++++/.   `ohhhhhhy+`          \n'
  printf '             :++++++++++++++++++++/-`  -shhs:`          \n'
  printf '             `+++++++++++++++++++++++-`  -`          \n'
  printf '              `......-...-/+++++++++++/`          \n'
  printf '                           `-/+++++++:`          \n'
  printf '                              `.:/+:`          \n'
  printf '\n'
  printf '\n'
  printf '             Welcome to the Mobify platform!    \n'
  printf '\n'
  printf '\n'

  docker pull mobify/platform-runner
  docker run -p 8443:8443 -v `pwd`:/app mobify/platform-runner
}

_stop() {
  docker ps -q --filter ancestor="mobify/platform-runner" | xargs docker stop || true
}

_deploy() {
  printf "Preparing a bundle...\n"

  sleep 3

  printf "Bundle is ready, deploying...\n"

  count=0
  until [ $count -eq 10 ]
  do
    printf "###"
    sleep 1
    count=`expr $count + 1`
  done

  curl -X PUT http://start.mobify.com/progress/deploy/enable
  printf "\nDone!\n"
}

_todo() {
  printf "Not yet implemented...\n"
}

_usage() {
  printf "Usage: $0 [command...]\n"
  printf "\nSupported commands:\n"
  printf "  start          Start the local Mobify development environment\n"
  printf "  stop           Stop the local Mobify development environment\n"
  printf "  deploy         Prepare a project bundle and deploy to the Mobify cloud\n"
  printf "  push           Send a test Push Notification\n"
  printf "  sdk            Run Mobify Progressive SDK commands\n"
  printf "  test           Run all unit tests\n"
  printf "  perf-test      Run all performance tests (Lighthouse, WPT)\n"
  printf "  help           This page\n"
}

opt="$1"
[[ -z "$opt" ]] && {
  _usage
  exit 0
}

case "$opt" in
  start)
    _start
    ;;
  stop)
    _stop
    ;;
  deploy)
    _deploy
    ;;
  help)
    _usage
    ;;
  *)
    _todo
    ;;
esac
